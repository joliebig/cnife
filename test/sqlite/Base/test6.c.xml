<?xml version="1.0" encoding="UTF-8" standalone="yes"?>
<unit xmlns="http://www.sdml.info/srcML/src" xmlns:cpp="http://www.sdml.info/srcML/cpp" language="C++" dir="test6.c" filename=""><comment type="block">/*
** 2004 May 22
**
** The author disclaims copyright to this source code.  In place of
** a legal notice, here is a blessing:
**
**    May you do good and not evil.
**    May you find forgiveness for yourself and forgive others.
**    May you share freely, never taking more than you give.
**
******************************************************************************
**
** This file contains code that modified the OS layer in order to simulate
** the effect on the database file of an OS crash or power failure.  This
** is used to test the ability of SQLite to recover from those situations.
**
** $Id: test6.c,v 1.41 2008/12/20 18:33:59 danielk1977 Exp $
*/</comment>
<cpp:if>#<cpp:directive>if</cpp:directive> <expr><name>SQLITE_TEST</name></expr></cpp:if>          <comment type="block">/* This file is used for testing only */</comment>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"sqliteInt.h"</cpp:file></cpp:include>
<cpp:include>#<cpp:directive>include</cpp:directive> <cpp:file>"tcl.h"</cpp:file></cpp:include>

<cpp:ifndef>#<cpp:directive>ifndef</cpp:directive> <name>SQLITE_OMIT_DISKIO</name></cpp:ifndef>  <comment type="block">/* This file is a no-op if disk I/O is disabled */</comment>

<comment type="block">/* #define TRACE_CRASHTEST */</comment>

<typedef>typedef <type><struct>struct <name>CrashFile</name> CrashFile;</struct></type></typedef>
<typedef>typedef <type><struct>struct <name>CrashGlobal</name> CrashGlobal;</struct></type></typedef>
<typedef>typedef <type><struct>struct <name>WriteBuffer</name> WriteBuffer;</struct></type></typedef>

<comment type="block">/*
** Method:
**
**   This layer is implemented as a wrapper around the "real" 
**   sqlite3_file object for the host system. Each time data is 
**   written to the file object, instead of being written to the
**   underlying file, the write operation is stored in an in-memory 
**   structure (type WriteBuffer). This structure is placed at the
**   end of a global ordered list (the write-list).
**
**   When data is read from a file object, the requested region is
**   first retrieved from the real file. The write-list is then 
**   traversed and data copied from any overlapping WriteBuffer 
**   structures to the output buffer. i.e. a read() operation following
**   one or more write() operations works as expected, even if no
**   data has actually been written out to the real file.
**
**   When a fsync() operation is performed, an operating system crash 
**   may be simulated, in which case exit(-1) is called (the call to 
**   xSync() never returns). Whether or not a crash is simulated,
**   the data associated with a subset of the WriteBuffer structures 
**   stored in the write-list is written to the real underlying files 
**   and the entries removed from the write-list. If a crash is simulated,
**   a subset of the buffers may be corrupted before the data is written.
**
**   The exact subset of the write-list written and/or corrupted is
**   determined by the simulated device characteristics and sector-size.
**
** "Normal" mode:
**
**   Normal mode is used when the simulated device has none of the
**   SQLITE_IOCAP_XXX flags set.
**
**   In normal mode, if the fsync() is not a simulated crash, the 
**   write-list is traversed from beginning to end. Each WriteBuffer
**   structure associated with the file handle used to call xSync()
**   is written to the real file and removed from the write-list.
**
**   If a crash is simulated, one of the following takes place for 
**   each WriteBuffer in the write-list, regardless of which 
**   file-handle it is associated with:
**
**     1. The buffer is correctly written to the file, just as if
**        a crash were not being simulated.
**
**     2. Nothing is done.
**
**     3. Garbage data is written to all sectors of the file that 
**        overlap the region specified by the WriteBuffer. Or garbage
**        data is written to some contiguous section within the 
**        overlapped sectors.
**
** Device Characteristic flag handling:
**
**   If the IOCAP_ATOMIC flag is set, then option (3) above is 
**   never selected.
**
**   If the IOCAP_ATOMIC512 flag is set, and the WriteBuffer represents
**   an aligned write() of an integer number of 512 byte regions, then
**   option (3) above is never selected. Instead, each 512 byte region
**   is either correctly written or left completely untouched. Similar
**   logic governs the behaviour if any of the other ATOMICXXX flags
**   is set.
**
**   If either the IOCAP_SAFEAPPEND or IOCAP_SEQUENTIAL flags are set
**   and a crash is being simulated, then an entry of the write-list is
**   selected at random. Everything in the list after the selected entry 
**   is discarded before processing begins.
**
**   If IOCAP_SEQUENTIAL is set and a crash is being simulated, option 
**   (1) is selected for all write-list entries except the last. If a 
**   crash is not being simulated, then all entries in the write-list
**   that occur before at least one write() on the file-handle specified
**   as part of the xSync() are written to their associated real files.
**
**   If IOCAP_SAFEAPPEND is set and the first byte written by the write()
**   operation is one byte past the current end of the file, then option
**   (1) is always selected.
*/</comment>

<comment type="block">/*
** Each write operation in the write-list is represented by an instance
** of the following structure.
**
** If zBuf is 0, then this structure represents a call to xTruncate(), 
** not xWrite(). In that case, iOffset is the size that the file is
** truncated to.
*/</comment>
<struct>struct <name>WriteBuffer</name> <block>{<public type="default">
  <decl_stmt><decl><type><name>i64</name></type> <name>iOffset</name></decl>;</decl_stmt>                 <comment type="block">/* Byte offset of the start of this write() */</comment>
  <decl_stmt><decl><type><name>int</name></type> <name>nBuf</name></decl>;</decl_stmt>                    <comment type="block">/* Number of bytes written */</comment>
  <decl_stmt><decl><type><name>u8</name> *</type><name>zBuf</name></decl>;</decl_stmt>                    <comment type="block">/* Pointer to copy of written data */</comment>
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pFile</name></decl>;</decl_stmt>            <comment type="block">/* File this write() applies to */</comment>

  <decl_stmt><decl><type><name>WriteBuffer</name> *</type><name>pNext</name></decl>;</decl_stmt>          <comment type="block">/* Next in CrashGlobal.pWriteList */</comment>
</public>}</block>;</struct>

<struct>struct <name>CrashFile</name> <block>{<public type="default">
  <decl_stmt><decl><type><name>const</name> <name>sqlite3_io_methods</name> *</type><name>pMethod</name></decl>;</decl_stmt>   <comment type="block">/* Must be first */</comment>
  <decl_stmt><decl><type><name>sqlite3_file</name> *</type><name>pRealFile</name></decl>;</decl_stmt>             <comment type="block">/* Underlying "real" file handle */</comment>
  <decl_stmt><decl><type><name>char</name> *</type><name>zName</name></decl>;</decl_stmt>

  <comment type="block">/* Cache of the entire file. This is used to speed up OsRead() and 
  ** OsFileSize() calls. Although both could be done by traversing the
  ** write-list, in practice this is impractically slow.
  */</comment>
  <decl_stmt><decl><type><name>int</name></type> <name>iSize</name></decl>;</decl_stmt>                           <comment type="block">/* Size of file in bytes */</comment>
  <decl_stmt><decl><type><name>int</name></type> <name>nData</name></decl>;</decl_stmt>                           <comment type="block">/* Size of buffer allocated at zData */</comment>
  <decl_stmt><decl><type><name>u8</name> *</type><name>zData</name></decl>;</decl_stmt>                           <comment type="block">/* Buffer containing file contents */</comment>
</public>}</block>;</struct>

<struct>struct <name>CrashGlobal</name> <block>{<public type="default">
  <decl_stmt><decl><type><name>WriteBuffer</name> *</type><name>pWriteList</name></decl>;</decl_stmt>     <comment type="block">/* Head of write-list */</comment>
  <decl_stmt><decl><type><name>WriteBuffer</name> *</type><name>pWriteListEnd</name></decl>;</decl_stmt>  <comment type="block">/* End of write-list */</comment>

  <decl_stmt><decl><type><name>int</name></type> <name>iSectorSize</name></decl>;</decl_stmt>             <comment type="block">/* Value of simulated sector size */</comment>
  <decl_stmt><decl><type><name>int</name></type> <name>iDeviceCharacteristics</name></decl>;</decl_stmt>  <comment type="block">/* Value of simulated device characteristics */</comment>

  <decl_stmt><decl><type><name>int</name></type> <name>iCrash</name></decl>;</decl_stmt>                  <comment type="block">/* Crash on the iCrash'th call to xSync() */</comment>
  <decl_stmt><decl><type><name>char</name></type> <name><name>zCrashFile</name><index>[<expr>500</expr>]</index></name></decl>;</decl_stmt>        <comment type="block">/* Crash during an xSync() on this file */</comment> 
</public>}</block>;</struct>

<decl_stmt><decl><type><name>static</name> <name>CrashGlobal</name></type> <name>g</name> =<init> <expr><block>{<expr>0</expr>, <expr>0</expr>, <expr><name>SQLITE_DEFAULT_SECTOR_SIZE</name></expr>, <expr>0</expr>, <expr>0</expr>}</block></expr></init></decl>;</decl_stmt>

<comment type="block">/*
** Set this global variable to 1 to enable crash testing.
*/</comment>
<decl_stmt><decl><type><name>static</name> <name>int</name></type> <name>sqlite3CrashTestEnable</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>

<function><type><name>static</name> <name>void</name> *</type><name>crash_malloc</name><parameter_list>(<param><decl><type><name>int</name></type> <name>nByte</name></decl></param>)</parameter_list><block>{
  <return>return <expr>(<name>void</name> *)<call><name>Tcl_Alloc</name><argument_list>(<argument><expr>(<name>size_t</name>)<name>nByte</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>void</name></type> <name>crash_free</name><parameter_list>(<param><decl><type><name>void</name> *</type><name>p</name></decl></param>)</parameter_list><block>{
  <expr_stmt><expr><call><name>Tcl_Free</name><argument_list>(<argument><expr><name>p</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>
<function><type><name>static</name> <name>void</name> *</type><name>crash_realloc</name><parameter_list>(<param><decl><type><name>void</name> *</type><name>p</name></decl></param>, <param><decl><type><name>int</name></type> <name>n</name></decl></param>)</parameter_list><block>{
  <return>return <expr>(<name>void</name> *)<call><name>Tcl_Realloc</name><argument_list>(<argument><expr><name>p</name></expr></argument>, <argument><expr>(<name>size_t</name>)<name>n</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>

<comment type="block">/*
** Flush the write-list as if xSync() had been called on file handle
** pFile. If isCrash is true, simulate a crash.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>writeListSync</name><parameter_list>(<param><decl><type><name>CrashFile</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>int</name></type> <name>isCrash</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>int</name></type> <name>rc</name> =<init> <expr><name>SQLITE_OK</name></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>iDc</name> =<init> <expr><name>g</name>.<name>iDeviceCharacteristics</name></expr></init></decl>;</decl_stmt>

  <decl_stmt><decl><type><name>WriteBuffer</name> *</type><name>pWrite</name></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>WriteBuffer</name> **</type><name>ppPtr</name></decl>;</decl_stmt>

  <comment type="block">/* If this is not a crash simulation, set pFinal to point to the 
  ** last element of the write-list that is associated with file handle
  ** pFile.
  **
  ** If this is a crash simulation, set pFinal to an arbitrarily selected
  ** element of the write-list.
  */</comment>
  <decl_stmt><decl><type><name>WriteBuffer</name> *</type><name>pFinal</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>
  <if>if<condition>( <expr>!<name>isCrash</name></expr> )</condition><then><block>{
    <for>for(<init><expr><name>pWrite</name>=<name>g</name>.<name>pWriteList</name></expr>;</init> <condition><expr><name>pWrite</name></expr>;</condition> <incr><expr><name>pWrite</name>=<name>pWrite</name>-&gt;<name>pNext</name></expr></incr>)<block>{
      <if>if<condition>( <expr><name>pWrite</name>-&gt;<name>pFile</name>==<name>pFile</name></expr> )</condition><then><block>{
        <expr_stmt><expr><name>pFinal</name> = <name>pWrite</name></expr>;</expr_stmt>
      }</block></then></if>
    }</block></for>
  }</block></then><else>else <if>if<condition>( <expr><name>iDc</name>&amp;(<name>SQLITE_IOCAP_SEQUENTIAL</name>|<name>SQLITE_IOCAP_SAFE_APPEND</name>)</expr> )</condition><then><block>{
    <decl_stmt><decl><type><name>int</name></type> <name>nWrite</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>iFinal</name></decl>;</decl_stmt>
    <for>for(<init><expr><name>pWrite</name>=<name>g</name>.<name>pWriteList</name></expr>;</init> <condition><expr><name>pWrite</name></expr>;</condition> <incr><expr><name>pWrite</name>=<name>pWrite</name>-&gt;<name>pNext</name></expr></incr>) <expr_stmt><expr><name>nWrite</name>++</expr>;</expr_stmt></for>
    <expr_stmt><expr><call><name>sqlite3_randomness</name><argument_list>(<argument><expr><call><name>sizeof</name><argument_list>(<argument><expr><name>int</name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr>&amp;<name>iFinal</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>iFinal</name> = ((<name>iFinal</name>&lt;0)?-1*<name>iFinal</name>:<name>iFinal</name>)%<name>nWrite</name></expr>;</expr_stmt>
    <for>for(<init><expr><name>pWrite</name>=<name>g</name>.<name>pWriteList</name></expr>;</init> <condition><expr><name>iFinal</name>&gt;0</expr>;</condition> <incr><expr><name>pWrite</name>=<name>pWrite</name>-&gt;<name>pNext</name></expr></incr>) <expr_stmt><expr><name>iFinal</name>--</expr>;</expr_stmt></for>
    <expr_stmt><expr><name>pFinal</name> = <name>pWrite</name></expr>;</expr_stmt>
  }</block></then></if></else></if>

<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>TRACE_CRASHTEST</name></cpp:ifdef>
  <expr_stmt><expr><call><name>printf</name><argument_list>(<argument><expr>"Sync %s (is %s crash)\n"</expr></argument>, <argument><expr><name>pFile</name>-&gt;<name>zName</name></expr></argument>, <argument><expr>(<name>isCrash</name>?"a":"not a")</expr></argument>)</argument_list></call></expr>;</expr_stmt>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>

  <expr_stmt><expr><name>ppPtr</name> = &amp;<name>g</name>.<name>pWriteList</name></expr>;</expr_stmt>
  <for>for(<init><expr><name>pWrite</name>=*<name>ppPtr</name></expr>;</init> <condition><expr><name>rc</name>==<name>SQLITE_OK</name> &amp;&amp; <name>pWrite</name></expr>;</condition> <incr><expr><name>pWrite</name>=*<name>ppPtr</name></expr></incr>)<block>{
    <decl_stmt><decl><type><name>sqlite3_file</name> *</type><name>pRealFile</name> =<init> <expr><name>pWrite</name>-&gt;<name>pFile</name>-&gt;<name>pRealFile</name></expr></init></decl>;</decl_stmt>

    <comment type="block">/* (eAction==1)      -&gt; write block out normally,
    ** (eAction==2)      -&gt; do nothing,
    ** (eAction==3)      -&gt; trash sectors.
    */</comment>
    <decl_stmt><decl><type><name>int</name></type> <name>eAction</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>
    <if>if<condition>( <expr>!<name>isCrash</name></expr> )</condition><then><block>{
      <expr_stmt><expr><name>eAction</name> = 2</expr>;</expr_stmt>
      <if>if<condition>( <expr>(<name>pWrite</name>-&gt;<name>pFile</name>==<name>pFile</name> || <name>iDc</name>&amp;<name>SQLITE_IOCAP_SEQUENTIAL</name>)</expr> )</condition><then><block>{
        <expr_stmt><expr><name>eAction</name> = 1</expr>;</expr_stmt>
      }</block></then></if>
    }</block></then><else>else<block>{
      <decl_stmt><decl><type><name>char</name></type> <name>random</name></decl>;</decl_stmt>
      <expr_stmt><expr><call><name>sqlite3_randomness</name><argument_list>(<argument><expr>1</expr></argument>, <argument><expr>&amp;<name>random</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

      <comment type="block">/* Do not select option 3 (sector trashing) if the IOCAP_ATOMIC flag 
      ** is set or this is an OsTruncate(), not an Oswrite().
      */</comment>
      <if>if<condition>( <expr>(<name>iDc</name>&amp;<name>SQLITE_IOCAP_ATOMIC</name>) || (<name>pWrite</name>-&gt;<name>zBuf</name>==0)</expr> )</condition><then><block>{
        <expr_stmt><expr><name>random</name> &amp;= 0x01</expr>;</expr_stmt>
      }</block></then></if>

      <comment type="block">/* If IOCAP_SEQUENTIAL is set and this is not the final entry
      ** in the truncated write-list, always select option 1 (write
      ** out correctly).
      */</comment>
      <if>if<condition>( <expr>(<name>iDc</name>&amp;<name>SQLITE_IOCAP_SEQUENTIAL</name> &amp;&amp; <name>pWrite</name>!=<name>pFinal</name>)</expr> )</condition><then><block>{
        <expr_stmt><expr><name>random</name> = 0</expr>;</expr_stmt>
      }</block></then></if>

      <comment type="block">/* If IOCAP_SAFE_APPEND is set and this OsWrite() operation is
      ** an append (first byte of the written region is 1 byte past the
      ** current EOF), always select option 1 (write out correctly).
      */</comment>
      <if>if<condition>( <expr><name>iDc</name>&amp;<name>SQLITE_IOCAP_SAFE_APPEND</name> &amp;&amp; <name>pWrite</name>-&gt;<name>zBuf</name></expr> )</condition><then><block>{
        <decl_stmt><decl><type><name>i64</name></type> <name>iSize</name></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>sqlite3OsFileSize</name><argument_list>(<argument><expr><name>pRealFile</name></expr></argument>, <argument><expr>&amp;<name>iSize</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if<condition>( <expr><name>iSize</name>==<name>pWrite</name>-&gt;<name>iOffset</name></expr> )</condition><then><block>{
          <expr_stmt><expr><name>random</name> = 0</expr>;</expr_stmt>
        }</block></then></if>
      }</block></then></if>

      <if>if<condition>( <expr>(<name>random</name>&amp;0x06)==0x06</expr> )</condition><then><block>{
        <expr_stmt><expr><name>eAction</name> = 3</expr>;</expr_stmt>
      }</block></then><else>else<block>{
        <expr_stmt><expr><name>eAction</name> = ((<name>random</name>&amp;0x01)?2:1)</expr>;</expr_stmt>
      }</block></else></if>
    }</block></else></if>

    <switch>switch<condition>( <expr><name>eAction</name></expr> )</condition><block>{
      <case>case <expr>1</expr>: <block>{               <comment type="block">/* Write out correctly */</comment>
        <if>if<condition>( <expr><name>pWrite</name>-&gt;<name>zBuf</name></expr> )</condition><then><block>{
          <expr_stmt><expr><name>rc</name> = <call><name>sqlite3OsWrite</name><argument_list>(
              <argument><expr><name>pRealFile</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>zBuf</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>nBuf</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>iOffset</name></expr></argument>
          )</argument_list></call></expr>;</expr_stmt>
        }</block></then><else>else<block>{
          <expr_stmt><expr><name>rc</name> = <call><name>sqlite3OsTruncate</name><argument_list>(<argument><expr><name>pRealFile</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>iOffset</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></else></if>
        <expr_stmt><expr>*<name>ppPtr</name> = <name>pWrite</name>-&gt;<name>pNext</name></expr>;</expr_stmt>
<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>TRACE_CRASHTEST</name></cpp:ifdef>
        <if>if<condition>( <expr><name>isCrash</name></expr> )</condition><then><block>{
          <expr_stmt><expr><call><name>printf</name><argument_list>(<argument><expr>"Writing %d bytes @ %d (%s)\n"</expr></argument>, 
            <argument><expr><name>pWrite</name>-&gt;<name>nBuf</name></expr></argument>, <argument><expr>(<name>int</name>)<name>pWrite</name>-&gt;<name>iOffset</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>pFile</name>-&gt;<name>zName</name></expr></argument>
          )</argument_list></call></expr>;</expr_stmt>
        }</block></then></if>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>
        <expr_stmt><expr><call><name>crash_free</name><argument_list>(<argument><expr><name>pWrite</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <break>break;</break>
      }</block>
      </case><case>case <expr>2</expr>: <block>{               <comment type="block">/* Do nothing */</comment>
        <expr_stmt><expr><name>ppPtr</name> = &amp;<name>pWrite</name>-&gt;<name>pNext</name></expr>;</expr_stmt>
<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>TRACE_CRASHTEST</name></cpp:ifdef>
        <if>if<condition>( <expr><name>isCrash</name></expr> )</condition><then><block>{
          <expr_stmt><expr><call><name>printf</name><argument_list>(<argument><expr>"Omiting %d bytes @ %d (%s)\n"</expr></argument>, 
            <argument><expr><name>pWrite</name>-&gt;<name>nBuf</name></expr></argument>, <argument><expr>(<name>int</name>)<name>pWrite</name>-&gt;<name>iOffset</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>pFile</name>-&gt;<name>zName</name></expr></argument>
          )</argument_list></call></expr>;</expr_stmt>
        }</block></then></if>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>
        <break>break;</break>
      }</block>
      </case><case>case <expr>3</expr>: <block>{               <comment type="block">/* Trash sectors */</comment>
        <decl_stmt><decl><type><name>u8</name> *</type><name>zGarbage</name></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>int</name></type> <name>iFirst</name> =<init> <expr>(<name>pWrite</name>-&gt;<name>iOffset</name>/<name>g</name>.<name>iSectorSize</name>)</expr></init></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>int</name></type> <name>iLast</name> =<init> <expr>(<name>pWrite</name>-&gt;<name>iOffset</name>+<name>pWrite</name>-&gt;<name>nBuf</name>-1)/<name>g</name>.<name>iSectorSize</name></expr></init></decl>;</decl_stmt>

        <expr_stmt><expr><call><name>assert</name><argument_list>(<argument><expr><name>pWrite</name>-&gt;<name>zBuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

<cpp:ifdef>#<cpp:directive>ifdef</cpp:directive> <name>TRACE_CRASHTEST</name></cpp:ifdef>
        <expr_stmt><expr><call><name>printf</name><argument_list>(<argument><expr>"Trashing %d sectors @ sector %d (%s)\n"</expr></argument>, 
            <argument><expr>1+<name>iLast</name>-<name>iFirst</name></expr></argument>, <argument><expr><name>iFirst</name></expr></argument>, <argument><expr><name>pWrite</name>-&gt;<name>pFile</name>-&gt;<name>zName</name></expr></argument>
        )</argument_list></call></expr>;</expr_stmt>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>

        <expr_stmt><expr><name>zGarbage</name> = <call><name>crash_malloc</name><argument_list>(<argument><expr><name>g</name>.<name>iSectorSize</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if<condition>( <expr><name>zGarbage</name></expr> )</condition><then><block>{
          <decl_stmt><decl><type><name>sqlite3_int64</name></type> <name>i</name></decl>;</decl_stmt>
          <for>for(<init><expr><name>i</name>=<name>iFirst</name></expr>;</init> <condition><expr><name>rc</name>==<name>SQLITE_OK</name> &amp;&amp; <name>i</name>&lt;=<name>iLast</name></expr>;</condition> <incr><expr><name>i</name>++</expr></incr>)<block>{
            <expr_stmt><expr><call><name>sqlite3_randomness</name><argument_list>(<argument><expr><name>g</name>.<name>iSectorSize</name></expr></argument>, <argument><expr><name>zGarbage</name></expr></argument>)</argument_list></call></expr>;</expr_stmt> 
            <expr_stmt><expr><name>rc</name> = <call><name>sqlite3OsWrite</name><argument_list>(
              <argument><expr><name>pRealFile</name></expr></argument>, <argument><expr><name>zGarbage</name></expr></argument>, <argument><expr><name>g</name>.<name>iSectorSize</name></expr></argument>, <argument><expr><name>i</name>*<name>g</name>.<name>iSectorSize</name></expr></argument>
            )</argument_list></call></expr>;</expr_stmt>
          }</block></for>
          <expr_stmt><expr><call><name>crash_free</name><argument_list>(<argument><expr><name>zGarbage</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        }</block></then><else>else<block>{
          <expr_stmt><expr><name>rc</name> = <name>SQLITE_NOMEM</name></expr>;</expr_stmt>
        }</block></else></if>

        <expr_stmt><expr><name>ppPtr</name> = &amp;<name>pWrite</name>-&gt;<name>pNext</name></expr>;</expr_stmt>
        <break>break;</break>
      }</block>

      </case><default>default:
        <expr_stmt><expr><call><name>assert</name><argument_list>(<argument><expr>!"Cannot happen"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    </default>}</block></switch>

    <if>if<condition>( <expr><name>pWrite</name>==<name>pFinal</name></expr> )</condition><then> <break>break;</break></then></if>
  }</block></for>

  <if>if<condition>( <expr><name>rc</name>==<name>SQLITE_OK</name> &amp;&amp; <name>isCrash</name></expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>exit</name><argument_list>(<argument><expr>-1</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></then></if>

  <for>for(<init><expr><name>pWrite</name>=<name>g</name>.<name>pWriteList</name></expr>;</init> <condition><expr><name>pWrite</name> &amp;&amp; <name>pWrite</name>-&gt;<name>pNext</name></expr>;</condition> <incr><expr><name>pWrite</name>=<name>pWrite</name>-&gt;<name>pNext</name></expr></incr>)<empty_stmt>;</empty_stmt></for>
  <expr_stmt><expr><name>g</name>.<name>pWriteListEnd</name> = <name>pWrite</name></expr>;</expr_stmt>

  <return>return <expr><name>rc</name></expr>;</return>
}</block></function>

<comment type="block">/*
** Add an entry to the end of the write-list.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>writeListAppend</name><parameter_list>(
  <param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>,
  <param><decl><type><name>sqlite3_int64</name></type> <name>iOffset</name></decl></param>,
  <param><decl><type><name>const</name> <name>u8</name> *</type><name>zBuf</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>nBuf</name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>WriteBuffer</name> *</type><name>pNew</name></decl>;</decl_stmt>

  <expr_stmt><expr><call><name>assert</name><argument_list>(<argument><expr>(<name>zBuf</name> &amp;&amp; <name>nBuf</name>) || (!<name>nBuf</name> &amp;&amp; !<name>zBuf</name>)</expr></argument>)</argument_list></call></expr>;</expr_stmt>

  <expr_stmt><expr><name>pNew</name> = (<name>WriteBuffer</name> *)<call><name>crash_malloc</name><argument_list>(<argument><expr><call><name>sizeof</name><argument_list>(<argument><expr><name>WriteBuffer</name></expr></argument>)</argument_list></call> + <name>nBuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <if>if<condition>( <expr><name>pNew</name>==0</expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>fprintf</name><argument_list>(<argument><expr><name>stderr</name></expr></argument>, <argument><expr>"out of memory in the crash simulator\n"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></then></if>
  <expr_stmt><expr><call><name>memset</name><argument_list>(<argument><expr><name>pNew</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr><call><name>sizeof</name><argument_list>(<argument><expr><name>WriteBuffer</name></expr></argument>)</argument_list></call>+<name>nBuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><name>pNew</name>-&gt;<name>iOffset</name> = <name>iOffset</name></expr>;</expr_stmt>
  <expr_stmt><expr><name>pNew</name>-&gt;<name>nBuf</name> = <name>nBuf</name></expr>;</expr_stmt>
  <expr_stmt><expr><name>pNew</name>-&gt;<name>pFile</name> = (<name>CrashFile</name> *)<name>pFile</name></expr>;</expr_stmt>
  <if>if<condition>( <expr><name>zBuf</name></expr> )</condition><then><block>{
    <expr_stmt><expr><name>pNew</name>-&gt;<name>zBuf</name> = (<name>u8</name> *)&amp;<name><name>pNew</name><index>[<expr>1</expr>]</index></name></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>memcpy</name><argument_list>(<argument><expr><name>pNew</name>-&gt;<name>zBuf</name></expr></argument>, <argument><expr><name>zBuf</name></expr></argument>, <argument><expr><name>nBuf</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></then></if>

  <if>if<condition>( <expr><name>g</name>.<name>pWriteList</name></expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>assert</name><argument_list>(<argument><expr><name>g</name>.<name>pWriteListEnd</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>g</name>.<name>pWriteListEnd</name>-&gt;<name>pNext</name> = <name>pNew</name></expr>;</expr_stmt>
  }</block></then><else>else<block>{
    <expr_stmt><expr><name>g</name>.<name>pWriteList</name> = <name>pNew</name></expr>;</expr_stmt>
  }</block></else></if>
  <expr_stmt><expr><name>g</name>.<name>pWriteListEnd</name> = <name>pNew</name></expr>;</expr_stmt>
  
  <return>return <expr><name>SQLITE_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** Close a crash-file.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfClose</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pCrash</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>
  <expr_stmt><expr><call><name>writeListSync</name><argument_list>(<argument><expr><name>pCrash</name></expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><call><name>sqlite3OsClose</name><argument_list>(<argument><expr><name>pCrash</name>-&gt;<name>pRealFile</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <return>return <expr><name>SQLITE_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** Read data from a crash-file.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfRead</name><parameter_list>(
  <param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, 
  <param><decl><type><name>void</name> *</type><name>zBuf</name></decl></param>, 
  <param><decl><type><name>int</name></type> <name>iAmt</name></decl></param>, 
  <param><decl><type><name>sqlite_int64</name></type> <name>iOfst</name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pCrash</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>

  <comment type="block">/* Check the file-size to see if this is a short-read */</comment>
  <if>if<condition>( <expr><name>pCrash</name>-&gt;<name>iSize</name>&lt;(<name>iOfst</name>+<name>iAmt</name>)</expr> )</condition><then><block>{
    <return>return <expr><name>SQLITE_IOERR_SHORT_READ</name></expr>;</return>
  }</block></then></if>

  <expr_stmt><expr><call><name>memcpy</name><argument_list>(<argument><expr><name>zBuf</name></expr></argument>, <argument><expr>&amp;<name>pCrash</name>-&gt;<name><name>zData</name><index>[<expr><name>iOfst</name></expr>]</index></name></expr></argument>, <argument><expr><name>iAmt</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <return>return <expr><name>SQLITE_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** Write data to a crash-file.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfWrite</name><parameter_list>(
  <param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, 
  <param><decl><type><name>const</name> <name>void</name> *</type><name>zBuf</name></decl></param>, 
  <param><decl><type><name>int</name></type> <name>iAmt</name></decl></param>, 
  <param><decl><type><name>sqlite_int64</name></type> <name>iOfst</name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pCrash</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>
  <if>if<condition>( <expr><name>iAmt</name>+<name>iOfst</name>&gt;<name>pCrash</name>-&gt;<name>iSize</name></expr> )</condition><then><block>{
    <expr_stmt><expr><name>pCrash</name>-&gt;<name>iSize</name> = <name>iAmt</name>+<name>iOfst</name></expr>;</expr_stmt>
  }</block></then></if>
  <while>while<condition>( <expr><name>pCrash</name>-&gt;<name>iSize</name>&gt;<name>pCrash</name>-&gt;<name>nData</name></expr> )</condition><block>{
    <decl_stmt><decl><type><name>u8</name> *</type><name>zNew</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>nNew</name> =<init> <expr>(<name>pCrash</name>-&gt;<name>nData</name>*2) + 4096</expr></init></decl>;</decl_stmt>
    <expr_stmt><expr><name>zNew</name> = <call><name>crash_realloc</name><argument_list>(<argument><expr><name>pCrash</name>-&gt;<name>zData</name></expr></argument>, <argument><expr><name>nNew</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if<condition>( <expr>!<name>zNew</name></expr> )</condition><then><block>{
      <return>return <expr><name>SQLITE_NOMEM</name></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><call><name>memset</name><argument_list>(<argument><expr>&amp;<name><name>zNew</name><index>[<expr><name>pCrash</name>-&gt;<name>nData</name></expr>]</index></name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr><name>nNew</name>-<name>pCrash</name>-&gt;<name>nData</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>pCrash</name>-&gt;<name>nData</name> = <name>nNew</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>pCrash</name>-&gt;<name>zData</name> = <name>zNew</name></expr>;</expr_stmt>
  }</block></while>
  <expr_stmt><expr><call><name>memcpy</name><argument_list>(<argument><expr>&amp;<name>pCrash</name>-&gt;<name><name>zData</name><index>[<expr><name>iOfst</name></expr>]</index></name></expr></argument>, <argument><expr><name>zBuf</name></expr></argument>, <argument><expr><name>iAmt</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <return>return <expr><call><name>writeListAppend</name><argument_list>(<argument><expr><name>pFile</name></expr></argument>, <argument><expr><name>iOfst</name></expr></argument>, <argument><expr><name>zBuf</name></expr></argument>, <argument><expr><name>iAmt</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>

<comment type="block">/*
** Truncate a crash-file.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfTruncate</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>sqlite_int64</name></type> <name>size</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pCrash</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>
  <expr_stmt><expr><call><name>assert</name><argument_list>(<argument><expr><name>size</name>&gt;=0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <if>if<condition>( <expr><name>pCrash</name>-&gt;<name>iSize</name>&gt;<name>size</name></expr> )</condition><then><block>{
    <expr_stmt><expr><name>pCrash</name>-&gt;<name>iSize</name> = <name>size</name></expr>;</expr_stmt>
  }</block></then></if>
  <return>return <expr><call><name>writeListAppend</name><argument_list>(<argument><expr><name>pFile</name></expr></argument>, <argument><expr><name>size</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</return>
}</block></function>

<comment type="block">/*
** Sync a crash-file.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfSync</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>int</name></type> <name>flags</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pCrash</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>isCrash</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>

  <decl_stmt><decl><type><name>const</name> <name>char</name> *</type><name>zName</name> =<init> <expr><name>pCrash</name>-&gt;<name>zName</name></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>const</name> <name>char</name> *</type><name>zCrashFile</name> =<init> <expr><name>g</name>.<name>zCrashFile</name></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>nName</name> =<init> <expr><call><name>strlen</name><argument_list>(<argument><expr><name>zName</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>nCrashFile</name> =<init> <expr><call><name>strlen</name><argument_list>(<argument><expr><name>zCrashFile</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

  <if>if<condition>( <expr><name>nCrashFile</name>&gt;0 &amp;&amp; <name><name>zCrashFile</name><index>[<expr><name>nCrashFile</name>-1</expr>]</index></name>=='*'</expr> )</condition><then><block>{
    <expr_stmt><expr><name>nCrashFile</name>--</expr>;</expr_stmt>
    <if>if<condition>( <expr><name>nName</name>&gt;<name>nCrashFile</name></expr> )</condition><then> <expr_stmt><expr><name>nName</name> = <name>nCrashFile</name></expr>;</expr_stmt></then></if>
  }</block></then></if>

  <if>if<condition>( <expr><name>nName</name>==<name>nCrashFile</name> &amp;&amp; 0==<call><name>memcmp</name><argument_list>(<argument><expr><name>zName</name></expr></argument>, <argument><expr><name>zCrashFile</name></expr></argument>, <argument><expr><name>nName</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <if>if<condition>( <expr>(--<name>g</name>.<name>iCrash</name>)==0</expr> )</condition><then> <expr_stmt><expr><name>isCrash</name> = 1</expr>;</expr_stmt></then></if>
  }</block></then></if>

  <return>return <expr><call><name>writeListSync</name><argument_list>(<argument><expr><name>pCrash</name></expr></argument>, <argument><expr><name>isCrash</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>

<comment type="block">/*
** Return the current file-size of the crash-file.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfFileSize</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>sqlite_int64</name> *</type><name>pSize</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pCrash</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>
  <expr_stmt><expr>*<name>pSize</name> = (<name>i64</name>)<name>pCrash</name>-&gt;<name>iSize</name></expr>;</expr_stmt>
  <return>return <expr><name>SQLITE_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** Calls related to file-locks are passed on to the real file handle.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfLock</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>int</name></type> <name>eLock</name></decl></param>)</parameter_list><block>{
  <return>return <expr><call><name>sqlite3OsLock</name><argument_list>(<argument><expr>((<name>CrashFile</name> *)<name>pFile</name>)-&gt;<name>pRealFile</name></expr></argument>, <argument><expr><name>eLock</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfUnlock</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>int</name></type> <name>eLock</name></decl></param>)</parameter_list><block>{
  <return>return <expr><call><name>sqlite3OsUnlock</name><argument_list>(<argument><expr>((<name>CrashFile</name> *)<name>pFile</name>)-&gt;<name>pRealFile</name></expr></argument>, <argument><expr><name>eLock</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfCheckReservedLock</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>int</name> *</type><name>pResOut</name></decl></param>)</parameter_list><block>{
  <return>return <expr><call><name>sqlite3OsCheckReservedLock</name><argument_list>(<argument><expr>((<name>CrashFile</name> *)<name>pFile</name>)-&gt;<name>pRealFile</name></expr></argument>, <argument><expr><name>pResOut</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfFileControl</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>, <param><decl><type><name>int</name></type> <name>op</name></decl></param>, <param><decl><type><name>void</name> *</type><name>pArg</name></decl></param>)</parameter_list><block>{
  <return>return <expr><call><name>sqlite3OsFileControl</name><argument_list>(<argument><expr>((<name>CrashFile</name> *)<name>pFile</name>)-&gt;<name>pRealFile</name></expr></argument>, <argument><expr><name>op</name></expr></argument>, <argument><expr><name>pArg</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>

<comment type="block">/*
** The xSectorSize() and xDeviceCharacteristics() functions return
** the global values configured by the [sqlite_crashparams] tcl
*  interface.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfSectorSize</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>)</parameter_list><block>{
  <return>return <expr><name>g</name>.<name>iSectorSize</name></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfDeviceCharacteristics</name><parameter_list>(<param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>)</parameter_list><block>{
  <return>return <expr><name>g</name>.<name>iDeviceCharacteristics</name></expr>;</return>
}</block></function>

<decl_stmt><decl><type><name>static</name> <name>const</name> <name>sqlite3_io_methods</name></type> <name>CrashFileVtab</name> =<init> <expr><block>{
  <expr>1</expr>,                            <comment type="block">/* iVersion */</comment>
  <expr><name>cfClose</name></expr>,                      <comment type="block">/* xClose */</comment>
  <expr><name>cfRead</name></expr>,                       <comment type="block">/* xRead */</comment>
  <expr><name>cfWrite</name></expr>,                      <comment type="block">/* xWrite */</comment>
  <expr><name>cfTruncate</name></expr>,                   <comment type="block">/* xTruncate */</comment>
  <expr><name>cfSync</name></expr>,                       <comment type="block">/* xSync */</comment>
  <expr><name>cfFileSize</name></expr>,                   <comment type="block">/* xFileSize */</comment>
  <expr><name>cfLock</name></expr>,                       <comment type="block">/* xLock */</comment>
  <expr><name>cfUnlock</name></expr>,                     <comment type="block">/* xUnlock */</comment>
  <expr><name>cfCheckReservedLock</name></expr>,          <comment type="block">/* xCheckReservedLock */</comment>
  <expr><name>cfFileControl</name></expr>,                <comment type="block">/* xFileControl */</comment>
  <expr><name>cfSectorSize</name></expr>,                 <comment type="block">/* xSectorSize */</comment>
  <expr><name>cfDeviceCharacteristics</name></expr>       <comment type="block">/* xDeviceCharacteristics */</comment>
}</block></expr></init></decl>;</decl_stmt>

<comment type="block">/*
** Application data for the crash VFS
*/</comment>
<struct>struct <name>crashAppData</name> <block>{<public type="default">
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pOrig</name></decl>;</decl_stmt>                   <comment type="block">/* Wrapped vfs structure */</comment>
</public>}</block>;</struct>

<comment type="block">/*
** Open a crash-file file handle.
**
** The caller will have allocated pVfs-&gt;szOsFile bytes of space
** at pFile. This file uses this space for the CrashFile structure
** and allocates space for the "real" file structure using 
** sqlite3_malloc(). The assumption here is (pVfs-&gt;szOsFile) is
** equal or greater than sizeof(CrashFile).
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>cfOpen</name><parameter_list>(
  <param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>,
  <param><decl><type><name>const</name> <name>char</name> *</type><name>zName</name></decl></param>,
  <param><decl><type><name>sqlite3_file</name> *</type><name>pFile</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>flags</name></decl></param>,
  <param><decl><type><name>int</name> *</type><name>pOutFlags</name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>rc</name></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>CrashFile</name> *</type><name>pWrapper</name> =<init> <expr>(<name>CrashFile</name> *)<name>pFile</name></expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>sqlite3_file</name> *</type><name>pReal</name> =<init> <expr>(<name>sqlite3_file</name>*)&amp;<name><name>pWrapper</name><index>[<expr>1</expr>]</index></name></expr></init></decl>;</decl_stmt>

  <expr_stmt><expr><call><name>memset</name><argument_list>(<argument><expr><name>pWrapper</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr><call><name>sizeof</name><argument_list>(<argument><expr><name>CrashFile</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><name>rc</name> = <call><name>sqlite3OsOpen</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>zName</name></expr></argument>, <argument><expr><name>pReal</name></expr></argument>, <argument><expr><name>flags</name></expr></argument>, <argument><expr><name>pOutFlags</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

  <if>if<condition>( <expr><name>rc</name>==<name>SQLITE_OK</name></expr> )</condition><then><block>{
    <decl_stmt><decl><type><name>i64</name></type> <name>iSize</name></decl>;</decl_stmt>
    <expr_stmt><expr><name>pWrapper</name>-&gt;<name>pMethod</name> = &amp;<name>CrashFileVtab</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>pWrapper</name>-&gt;<name>zName</name> = (<name>char</name> *)<name>zName</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>pWrapper</name>-&gt;<name>pRealFile</name> = <name>pReal</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>rc</name> = <call><name>sqlite3OsFileSize</name><argument_list>(<argument><expr><name>pReal</name></expr></argument>, <argument><expr>&amp;<name>iSize</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <expr_stmt><expr><name>pWrapper</name>-&gt;<name>iSize</name> = (<name>int</name>)<name>iSize</name></expr>;</expr_stmt>
  }</block></then></if>
  <if>if<condition>( <expr><name>rc</name>==<name>SQLITE_OK</name></expr> )</condition><then><block>{
    <expr_stmt><expr><name>pWrapper</name>-&gt;<name>nData</name> = (4096 + <name>pWrapper</name>-&gt;<name>iSize</name>)</expr>;</expr_stmt>
    <expr_stmt><expr><name>pWrapper</name>-&gt;<name>zData</name> = <call><name>crash_malloc</name><argument_list>(<argument><expr><name>pWrapper</name>-&gt;<name>nData</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <if>if<condition>( <expr><name>pWrapper</name>-&gt;<name>zData</name></expr> )</condition><then><block>{
      <expr_stmt><expr><call><name>memset</name><argument_list>(<argument><expr><name>pWrapper</name>-&gt;<name>zData</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr><name>pWrapper</name>-&gt;<name>nData</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
      <expr_stmt><expr><name>rc</name> = <call><name>sqlite3OsRead</name><argument_list>(<argument><expr><name>pReal</name></expr></argument>, <argument><expr><name>pWrapper</name>-&gt;<name>zData</name></expr></argument>, <argument><expr><name>pWrapper</name>-&gt;<name>iSize</name></expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt> 
    }</block></then><else>else<block>{
      <expr_stmt><expr><name>rc</name> = <name>SQLITE_NOMEM</name></expr>;</expr_stmt>
    }</block></else></if>
  }</block></then></if>
  <if>if<condition>( <expr><name>rc</name>!=<name>SQLITE_OK</name> &amp;&amp; <name>pWrapper</name>-&gt;<name>pMethod</name></expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>sqlite3OsClose</name><argument_list>(<argument><expr><name>pFile</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></then></if>
  <return>return <expr><name>rc</name></expr>;</return>
}</block></function>

<function><type><name>static</name> <name>int</name></type> <name>cfDelete</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>const</name> <name>char</name> *</type><name>zPath</name></decl></param>, <param><decl><type><name>int</name></type> <name>dirSync</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xDelete</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>zPath</name></expr></argument>, <argument><expr><name>dirSync</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfAccess</name><parameter_list>(
  <param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, 
  <param><decl><type><name>const</name> <name>char</name> *</type><name>zPath</name></decl></param>, 
  <param><decl><type><name>int</name></type> <name>flags</name></decl></param>, 
  <param><decl><type><name>int</name> *</type><name>pResOut</name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xAccess</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>zPath</name></expr></argument>, <argument><expr><name>flags</name></expr></argument>, <argument><expr><name>pResOut</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfFullPathname</name><parameter_list>(
  <param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, 
  <param><decl><type><name>const</name> <name>char</name> *</type><name>zPath</name></decl></param>, 
  <param><decl><type><name>int</name></type> <name>nPathOut</name></decl></param>,
  <param><decl><type><name>char</name> *</type><name>zPathOut</name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xFullPathname</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>zPath</name></expr></argument>, <argument><expr><name>nPathOut</name></expr></argument>, <argument><expr><name>zPathOut</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>void</name> *</type><name>cfDlOpen</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>const</name> <name>char</name> *</type><name>zPath</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xDlOpen</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>zPath</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>void</name></type> <name>cfDlError</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>int</name></type> <name>nByte</name></decl></param>, <param><decl><type><name>char</name> *</type><name>zErrMsg</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <expr_stmt><expr><name>pVfs</name>-&gt;<call><name>xDlError</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>nByte</name></expr></argument>, <argument><expr><name>zErrMsg</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>
<decl_stmt><decl><type><name>static</name></type> <name>void</name> <argument_list>(<argument><expr>*<call><name>cfDlSym</name><argument_list>(<argument><expr><name>sqlite3_vfs</name> *<name>pCfVfs</name></expr></argument>, <argument><expr><name>void</name> *<name>pH</name></expr></argument>, <argument><expr><name>const</name> <name>char</name> *<name>zSym</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list><argument_list>(<argument><expr><name>void</name></expr></argument>)</argument_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xDlSym</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>pH</name></expr></argument>, <argument><expr><name>zSym</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></decl></decl_stmt>
<function><type><name>static</name> <name>void</name></type> <name>cfDlClose</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>void</name> *</type><name>pHandle</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <expr_stmt><expr><name>pVfs</name>-&gt;<call><name>xDlClose</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>pHandle</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfRandomness</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>int</name></type> <name>nByte</name></decl></param>, <param><decl><type><name>char</name> *</type><name>zBufOut</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xRandomness</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>nByte</name></expr></argument>, <argument><expr><name>zBufOut</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfSleep</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>int</name></type> <name>nMicro</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xSleep</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>nMicro</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>
<function><type><name>static</name> <name>int</name></type> <name>cfCurrentTime</name><parameter_list>(<param><decl><type><name>sqlite3_vfs</name> *</type><name>pCfVfs</name></decl></param>, <param><decl><type><name>double</name> *</type><name>pTimeOut</name></decl></param>)</parameter_list><block>{
  <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pVfs</name> =<init> <expr>(<name>sqlite3_vfs</name> *)<name>pCfVfs</name>-&gt;<name>pAppData</name></expr></init></decl>;</decl_stmt>
  <return>return <expr><name>pVfs</name>-&gt;<call><name>xCurrentTime</name><argument_list>(<argument><expr><name>pVfs</name></expr></argument>, <argument><expr><name>pTimeOut</name></expr></argument>)</argument_list></call></expr>;</return>
}</block></function>

<function><type><name>static</name> <name>int</name></type> <name>processDevSymArgs</name><parameter_list>(
  <param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>objc</name></decl></param>,
  <param><decl><type><name>Tcl_Obj</name> *<name>CONST</name></type> <name><name>objv</name><index>[]</index></name></decl></param>,
  <param><decl><type><name>int</name> *</type><name>piDeviceChar</name></decl></param>,
  <param><decl><type><name>int</name> *</type><name>piSectorSize</name></decl></param>
)</parameter_list><block>{
  <struct>struct <name>DeviceFlag</name> <block>{<public type="default">
    <decl_stmt><decl><type><name>char</name> *</type><name>zName</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>int</name></type> <name>iValue</name></decl>;</decl_stmt>
  </public>}</block> <decl><name><name>aFlag</name><index>[]</index></name> =<init> <expr><block>{
    <expr><block>{ <expr>"atomic"</expr>,      <expr><name>SQLITE_IOCAP_ATOMIC</name></expr>      }</block></expr>,
    <expr><block>{ <expr>"atomic512"</expr>,   <expr><name>SQLITE_IOCAP_ATOMIC512</name></expr>   }</block></expr>,
    <expr><block>{ <expr>"atomic1k"</expr>,    <expr><name>SQLITE_IOCAP_ATOMIC1K</name></expr>    }</block></expr>,
    <expr><block>{ <expr>"atomic2k"</expr>,    <expr><name>SQLITE_IOCAP_ATOMIC2K</name></expr>    }</block></expr>,
    <expr><block>{ <expr>"atomic4k"</expr>,    <expr><name>SQLITE_IOCAP_ATOMIC4K</name></expr>    }</block></expr>,
    <expr><block>{ <expr>"atomic8k"</expr>,    <expr><name>SQLITE_IOCAP_ATOMIC8K</name></expr>    }</block></expr>,
    <expr><block>{ <expr>"atomic16k"</expr>,   <expr><name>SQLITE_IOCAP_ATOMIC16K</name></expr>   }</block></expr>,
    <expr><block>{ <expr>"atomic32k"</expr>,   <expr><name>SQLITE_IOCAP_ATOMIC32K</name></expr>   }</block></expr>,
    <expr><block>{ <expr>"atomic64k"</expr>,   <expr><name>SQLITE_IOCAP_ATOMIC64K</name></expr>   }</block></expr>,
    <expr><block>{ <expr>"sequential"</expr>,  <expr><name>SQLITE_IOCAP_SEQUENTIAL</name></expr>  }</block></expr>,
    <expr><block>{ <expr>"safe_append"</expr>, <expr><name>SQLITE_IOCAP_SAFE_APPEND</name></expr> }</block></expr>,
    <expr><block>{ <expr>0</expr>, <expr>0</expr> }</block></expr>
  }</block></expr></init></decl>;</struct>

  <decl_stmt><decl><type><name>int</name></type> <name>i</name></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>iDc</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>iSectorSize</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>setSectorsize</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>setDeviceChar</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>

  <for>for(<init><expr><name>i</name>=0</expr>;</init> <condition><expr><name>i</name>&lt;<name>objc</name></expr>;</condition> <incr><expr><name>i</name>+=2</expr></incr>)<block>{
    <decl_stmt><decl><type><name>int</name></type> <name>nOpt</name></decl>;</decl_stmt>
    <decl_stmt><decl><type><name>char</name> *</type><name>zOpt</name> =<init> <expr><call><name>Tcl_GetStringFromObj</name><argument_list>(<argument><expr><name><name>objv</name><index>[<expr><name>i</name></expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>nOpt</name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>

    <if>if<condition>( <expr>(<name>nOpt</name>&gt;11 || <name>nOpt</name>&lt;2 || <call><name>strncmp</name><argument_list>(<argument><expr>"-sectorsize"</expr></argument>, <argument><expr><name>zOpt</name></expr></argument>, <argument><expr><name>nOpt</name></expr></argument>)</argument_list></call>) 
     &amp;&amp; (<name>nOpt</name>&gt;16 || <name>nOpt</name>&lt;2 || <call><name>strncmp</name><argument_list>(<argument><expr>"-characteristics"</expr></argument>, <argument><expr><name>zOpt</name></expr></argument>, <argument><expr><name>nOpt</name></expr></argument>)</argument_list></call>)</expr>
    )</condition><then><block>{
      <expr_stmt><expr><call><name>Tcl_AppendResult</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, 
        <argument><expr>"Bad option: \""</expr></argument>, <argument><expr><name>zOpt</name></expr></argument>, 
        <argument><expr>"\" - must be \"-characteristics\" or \"-sectorsize\""</expr></argument>, <argument><expr>0</expr></argument>
      )</argument_list></call></expr>;</expr_stmt>
      <return>return <expr><name>TCL_ERROR</name></expr>;</return>
    }</block></then></if>
    <if>if<condition>( <expr><name>i</name>==<name>objc</name>-1</expr> )</condition><then><block>{
      <expr_stmt><expr><call><name>Tcl_AppendResult</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"Option requires an argument: \""</expr></argument>, <argument><expr><name>zOpt</name></expr></argument>, <argument><expr>"\""</expr></argument>,<argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
      <return>return <expr><name>TCL_ERROR</name></expr>;</return>
    }</block></then></if>

    <if>if<condition>( <expr><name><name>zOpt</name><index>[<expr>1</expr>]</index></name>=='s'</expr> )</condition><then><block>{
      <if>if<condition>( <expr><call><name>Tcl_GetIntFromObj</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr><name><name>objv</name><index>[<expr><name>i</name>+1</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>iSectorSize</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
        <return>return <expr><name>TCL_ERROR</name></expr>;</return>
      }</block></then></if>
      <expr_stmt><expr><name>setSectorsize</name> = 1</expr>;</expr_stmt>
    }</block></then><else>else<block>{
      <decl_stmt><decl><type><name>int</name></type> <name>j</name></decl>;</decl_stmt>
      <decl_stmt><decl><type><name>Tcl_Obj</name> **</type><name>apObj</name></decl>;</decl_stmt>
      <decl_stmt><decl><type><name>int</name></type> <name>nObj</name></decl>;</decl_stmt>
      <if>if<condition>( <expr><call><name>Tcl_ListObjGetElements</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr><name><name>objv</name><index>[<expr><name>i</name>+1</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>nObj</name></expr></argument>, <argument><expr>&amp;<name>apObj</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
        <return>return <expr><name>TCL_ERROR</name></expr>;</return>
      }</block></then></if>
      <for>for(<init><expr><name>j</name>=0</expr>;</init> <condition><expr><name>j</name>&lt;<name>nObj</name></expr>;</condition> <incr><expr><name>j</name>++</expr></incr>)<block>{
        <decl_stmt><decl><type><name>int</name></type> <name>rc</name></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>int</name></type> <name>iChoice</name></decl>;</decl_stmt>
        <decl_stmt><decl><type><name>Tcl_Obj</name> *</type><name>pFlag</name> =<init> <expr><call><name>Tcl_DuplicateObj</name><argument_list>(<argument><expr><name><name>apObj</name><index>[<expr><name>j</name></expr>]</index></name></expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
        <expr_stmt><expr><call><name>Tcl_IncrRefCount</name><argument_list>(<argument><expr><name>pFlag</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>Tcl_UtfToLower</name><argument_list>(<argument><expr><call><name>Tcl_GetString</name><argument_list>(<argument><expr><name>pFlag</name></expr></argument>)</argument_list></call></expr></argument>)</argument_list></call></expr>;</expr_stmt>
 
        <expr_stmt><expr><name>rc</name> = <call><name>Tcl_GetIndexFromObjStruct</name><argument_list>(
            <argument><expr><name>interp</name></expr></argument>, <argument><expr><name>pFlag</name></expr></argument>, <argument><expr><name>aFlag</name></expr></argument>, <argument><expr><call><name>sizeof</name><argument_list>(<argument><expr><name><name>aFlag</name><index>[<expr>0</expr>]</index></name></expr></argument>)</argument_list></call></expr></argument>, <argument><expr>"no such flag"</expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>&amp;<name>iChoice</name></expr></argument>
        )</argument_list></call></expr>;</expr_stmt>
        <expr_stmt><expr><call><name>Tcl_DecrRefCount</name><argument_list>(<argument><expr><name>pFlag</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
        <if>if<condition>( <expr><name>rc</name></expr> )</condition><then><block>{
          <return>return <expr><name>TCL_ERROR</name></expr>;</return>
        }</block></then></if>

        <expr_stmt><expr><name>iDc</name> |= <name><name>aFlag</name><index>[<expr><name>iChoice</name></expr>]</index></name>.<name>iValue</name></expr>;</expr_stmt>
      }</block></for>
      <expr_stmt><expr><name>setDeviceChar</name> = 1</expr>;</expr_stmt>
    }</block></else></if>
  }</block></for>

  <if>if<condition>( <expr><name>setDeviceChar</name></expr> )</condition><then><block>{
    <expr_stmt><expr>*<name>piDeviceChar</name> = <name>iDc</name></expr>;</expr_stmt>
  }</block></then></if>
  <if>if<condition>( <expr><name>setSectorsize</name></expr> )</condition><then><block>{
    <expr_stmt><expr>*<name>piSectorSize</name> = <name>iSectorSize</name></expr>;</expr_stmt>
  }</block></then></if>

  <return>return <expr><name>TCL_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** tclcmd:   sqlite_crash_enable ENABLE
**
** Parameter ENABLE must be a boolean value. If true, then the "crash"
** vfs is added to the system. If false, it is removed.
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>crashEnableCmd</name><parameter_list>(
  <param><decl><type><name>void</name> *</type> <name>clientData</name></decl></param>,
  <param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>objc</name></decl></param>,
  <param><decl><type><name>Tcl_Obj</name> *<name>CONST</name></type> <name><name>objv</name><index>[]</index></name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>int</name></type> <name>isEnable</name></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>static</name> <name>sqlite3_vfs</name></type> <name>crashVfs</name> =<init> <expr><block>{
    <expr>1</expr>,                  <comment type="block">/* iVersion */</comment>
    <expr>0</expr>,                  <comment type="block">/* szOsFile */</comment>
    <expr>0</expr>,                  <comment type="block">/* mxPathname */</comment>
    <expr>0</expr>,                  <comment type="block">/* pNext */</comment>
    <expr>"crash"</expr>,            <comment type="block">/* zName */</comment>
    <expr>0</expr>,                  <comment type="block">/* pAppData */</comment>
  
    <expr><name>cfOpen</name></expr>,               <comment type="block">/* xOpen */</comment>
    <expr><name>cfDelete</name></expr>,             <comment type="block">/* xDelete */</comment>
    <expr><name>cfAccess</name></expr>,             <comment type="block">/* xAccess */</comment>
    <expr><name>cfFullPathname</name></expr>,       <comment type="block">/* xFullPathname */</comment>
    <expr><name>cfDlOpen</name></expr>,             <comment type="block">/* xDlOpen */</comment>
    <expr><name>cfDlError</name></expr>,            <comment type="block">/* xDlError */</comment>
    <expr><name>cfDlSym</name></expr>,              <comment type="block">/* xDlSym */</comment>
    <expr><name>cfDlClose</name></expr>,            <comment type="block">/* xDlClose */</comment>
    <expr><name>cfRandomness</name></expr>,         <comment type="block">/* xRandomness */</comment>
    <expr><name>cfSleep</name></expr>,              <comment type="block">/* xSleep */</comment>
    <expr><name>cfCurrentTime</name></expr>         <comment type="block">/* xCurrentTime */</comment>
  }</block></expr></init></decl>;</decl_stmt>

  <if>if<condition>( <expr><name>objc</name>!=2</expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>Tcl_WrongNumArgs</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>1</expr></argument>, <argument><expr><name>objv</name></expr></argument>, <argument><expr>"ENABLE"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>

  <if>if<condition>( <expr><call><name>Tcl_GetBooleanFromObj</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr><name><name>objv</name><index>[<expr>1</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>isEnable</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>

  <if>if<condition>( <expr>(<name>isEnable</name> &amp;&amp; <name>crashVfs</name>.<name>pAppData</name>) || (!<name>isEnable</name> &amp;&amp; !<name>crashVfs</name>.<name>pAppData</name>)</expr> )</condition><then><block>{
    <return>return <expr><name>TCL_OK</name></expr>;</return>
  }</block></then></if>

  <if>if<condition>( <expr><name>crashVfs</name>.<name>pAppData</name>==0</expr> )</condition><then><block>{
    <decl_stmt><decl><type><name>sqlite3_vfs</name> *</type><name>pOriginalVfs</name> =<init> <expr><call><name>sqlite3_vfs_find</name><argument_list>(<argument><expr>0</expr></argument>)</argument_list></call></expr></init></decl>;</decl_stmt>
    <expr_stmt><expr><name>crashVfs</name>.<name>mxPathname</name> = <name>pOriginalVfs</name>-&gt;<name>mxPathname</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>crashVfs</name>.<name>pAppData</name> = (<name>void</name> *)<name>pOriginalVfs</name></expr>;</expr_stmt>
    <expr_stmt><expr><name>crashVfs</name>.<name>szOsFile</name> = <call><name>sizeof</name><argument_list>(<argument><expr><name>CrashFile</name></expr></argument>)</argument_list></call> + <name>pOriginalVfs</name>-&gt;<name>szOsFile</name></expr>;</expr_stmt>
    <expr_stmt><expr><call><name>sqlite3_vfs_register</name><argument_list>(<argument><expr>&amp;<name>crashVfs</name></expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></then><else>else<block>{
    <expr_stmt><expr><name>crashVfs</name>.<name>pAppData</name> = 0</expr>;</expr_stmt>
    <expr_stmt><expr><call><name>sqlite3_vfs_unregister</name><argument_list>(<argument><expr>&amp;<name>crashVfs</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></else></if>

  <return>return <expr><name>TCL_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** tclcmd:   sqlite_crashparams ?OPTIONS? DELAY CRASHFILE
**
** This procedure implements a TCL command that enables crash testing
** in testfixture.  Once enabled, crash testing cannot be disabled.
**
** Available options are "-characteristics" and "-sectorsize". Both require
** an argument. For -sectorsize, this is the simulated sector size in
** bytes. For -characteristics, the argument must be a list of io-capability
** flags to simulate. Valid flags are "atomic", "atomic512", "atomic1K",
** "atomic2K", "atomic4K", "atomic8K", "atomic16K", "atomic32K", 
** "atomic64K", "sequential" and "safe_append".
**
** Example:
**
**   sqlite_crashparams -sect 1024 -char {atomic sequential} ./test.db 1
**
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>crashParamsObjCmd</name><parameter_list>(
  <param><decl><type><name>void</name> *</type> <name>clientData</name></decl></param>,
  <param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>objc</name></decl></param>,
  <param><decl><type><name>Tcl_Obj</name> *<name>CONST</name></type> <name><name>objv</name><index>[]</index></name></decl></param>
)</parameter_list><block>{
  <decl_stmt><decl><type><name>int</name></type> <name>iDelay</name></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>const</name> <name>char</name> *</type><name>zCrashFile</name></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>nCrashFile</name>, <name>iDc</name>, <name>iSectorSize</name></decl>;</decl_stmt>

  <expr_stmt><expr><name>iDc</name> = -1</expr>;</expr_stmt>
  <expr_stmt><expr><name>iSectorSize</name> = -1</expr>;</expr_stmt>

  <if>if<condition>( <expr><name>objc</name>&lt;3</expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>Tcl_WrongNumArgs</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>1</expr></argument>, <argument><expr><name>objv</name></expr></argument>, <argument><expr>"?OPTIONS? DELAY CRASHFILE"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <goto>goto <name>error</name>;</goto>
  }</block></then></if>

  <expr_stmt><expr><name>zCrashFile</name> = <call><name>Tcl_GetStringFromObj</name><argument_list>(<argument><expr><name><name>objv</name><index>[<expr><name>objc</name>-1</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>nCrashFile</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <if>if<condition>( <expr><name>nCrashFile</name>&gt;=<call><name>sizeof</name><argument_list>(<argument><expr><name>g</name>.<name>zCrashFile</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>Tcl_AppendResult</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"Filename is too long: \""</expr></argument>, <argument><expr><name>zCrashFile</name></expr></argument>, <argument><expr>"\""</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <goto>goto <name>error</name>;</goto>
  }</block></then></if>
  <if>if<condition>( <expr><call><name>Tcl_GetIntFromObj</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr><name><name>objv</name><index>[<expr><name>objc</name>-2</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>iDelay</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <goto>goto <name>error</name>;</goto>
  }</block></then></if>

  <if>if<condition>( <expr><call><name>processDevSymArgs</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr><name>objc</name>-3</expr></argument>, <argument><expr>&amp;<name><name>objv</name><index>[<expr>1</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>iDc</name></expr></argument>, <argument><expr>&amp;<name>iSectorSize</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>

  <if>if<condition>( <expr><name>iDc</name>&gt;=0</expr> )</condition><then><block>{
    <expr_stmt><expr><name>g</name>.<name>iDeviceCharacteristics</name> = <name>iDc</name></expr>;</expr_stmt>
  }</block></then></if>
  <if>if<condition>( <expr><name>iSectorSize</name>&gt;=0</expr> )</condition><then><block>{
    <expr_stmt><expr><name>g</name>.<name>iSectorSize</name> = <name>iSectorSize</name></expr>;</expr_stmt>
  }</block></then></if>

  <expr_stmt><expr><name>g</name>.<name>iCrash</name> = <name>iDelay</name></expr>;</expr_stmt>
  <expr_stmt><expr><call><name>memcpy</name><argument_list>(<argument><expr><name>g</name>.<name>zCrashFile</name></expr></argument>, <argument><expr><name>zCrashFile</name></expr></argument>, <argument><expr><name>nCrashFile</name>+1</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><name>sqlite3CrashTestEnable</name> = 1</expr>;</expr_stmt>
  <return>return <expr><name>TCL_OK</name></expr>;</return>

<label><name>error</name>:</label>
  <return>return <expr><name>TCL_ERROR</name></expr>;</return>
}</block></function>

<function><type><name>static</name> <name>int</name></type> <name>devSymObjCmd</name><parameter_list>(
  <param><decl><type><name>void</name> *</type> <name>clientData</name></decl></param>,
  <param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>objc</name></decl></param>,
  <param><decl><type><name>Tcl_Obj</name> *<name>CONST</name></type> <name><name>objv</name><index>[]</index></name></decl></param>
)</parameter_list><block>{
  <function_decl><type><name>void</name></type> <name>devsym_register</name><parameter_list>(<param><decl><type><name>int</name></type> <name>iDeviceChar</name></decl></param>, <param><decl><type><name>int</name></type> <name>iSectorSize</name></decl></param>)</parameter_list>;</function_decl>

  <decl_stmt><decl><type><name>int</name></type> <name>iDc</name> =<init> <expr>-1</expr></init></decl>;</decl_stmt>
  <decl_stmt><decl><type><name>int</name></type> <name>iSectorSize</name> =<init> <expr>-1</expr></init></decl>;</decl_stmt>

  <if>if<condition>( <expr><call><name>processDevSymArgs</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr><name>objc</name>-1</expr></argument>, <argument><expr>&amp;<name><name>objv</name><index>[<expr>1</expr>]</index></name></expr></argument>, <argument><expr>&amp;<name>iDc</name></expr></argument>, <argument><expr>&amp;<name>iSectorSize</name></expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>
  <expr_stmt><expr><call><name>devsym_register</name><argument_list>(<argument><expr><name>iDc</name></expr></argument>, <argument><expr><name>iSectorSize</name></expr></argument>)</argument_list></call></expr>;</expr_stmt>

  <return>return <expr><name>TCL_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** tclcmd: register_jt_vfs ?-default? PARENT-VFS
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>jtObjCmd</name><parameter_list>(
  <param><decl><type><name>void</name> *</type> <name>clientData</name></decl></param>,
  <param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>objc</name></decl></param>,
  <param><decl><type><name>Tcl_Obj</name> *<name>CONST</name></type> <name><name>objv</name><index>[]</index></name></decl></param>
)</parameter_list><block>{
  <function_decl><type><name>int</name></type> <name>jt_register</name><parameter_list>(<param><decl><type><name>char</name> *</type></decl></param>, <param><decl><type><name>int</name></type></decl></param>)</parameter_list>;</function_decl>
  <decl_stmt><decl><type><name>char</name> *</type><name>zParent</name> =<init> <expr>0</expr></init></decl>;</decl_stmt>

  <if>if<condition>( <expr><name>objc</name>!=2 &amp;&amp; <name>objc</name>!=3</expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>Tcl_WrongNumArgs</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>1</expr></argument>, <argument><expr><name>objv</name></expr></argument>, <argument><expr>"?-default? PARENT-VFS"</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>
  <expr_stmt><expr><name>zParent</name> = <call><name>Tcl_GetString</name><argument_list>(<argument><expr><name><name>objv</name><index>[<expr>1</expr>]</index></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <if>if<condition>( <expr><name>objc</name>==3</expr> )</condition><then><block>{
    <if>if<condition>( <expr><call><name>strcmp</name><argument_list>(<argument><expr><name>zParent</name></expr></argument>, <argument><expr>"-default"</expr></argument>)</argument_list></call></expr> )</condition><then><block>{
      <expr_stmt><expr><call><name>Tcl_AppendResult</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, 
          <argument><expr>"bad option \""</expr></argument>, <argument><expr><name>zParent</name></expr></argument>, <argument><expr>"\": must be -default"</expr></argument>, <argument><expr>0</expr></argument>
      )</argument_list></call></expr>;</expr_stmt>
      <return>return <expr><name>TCL_ERROR</name></expr>;</return>
    }</block></then></if>
    <expr_stmt><expr><name>zParent</name> = <call><name>Tcl_GetString</name><argument_list>(<argument><expr><name><name>objv</name><index>[<expr>2</expr>]</index></name></expr></argument>)</argument_list></call></expr>;</expr_stmt>
  }</block></then></if>

  <if>if<condition>( <expr>!(*<name>zParent</name>)</expr> )</condition><then><block>{
    <expr_stmt><expr><name>zParent</name> = 0</expr>;</expr_stmt>
  }</block></then></if>
  <if>if<condition>( <expr><call><name>jt_register</name><argument_list>(<argument><expr><name>zParent</name></expr></argument>, <argument><expr><name>objc</name>==3</expr></argument>)</argument_list></call></expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>Tcl_AppendResult</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"Error in jt_register"</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>

  <return>return <expr><name>TCL_OK</name></expr>;</return>
}</block></function>

<comment type="block">/*
** tclcmd: unregister_jt_vfs
*/</comment>
<function><type><name>static</name> <name>int</name></type> <name>jtUnregisterObjCmd</name><parameter_list>(
  <param><decl><type><name>void</name> *</type> <name>clientData</name></decl></param>,
  <param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>,
  <param><decl><type><name>int</name></type> <name>objc</name></decl></param>,
  <param><decl><type><name>Tcl_Obj</name> *<name>CONST</name></type> <name><name>objv</name><index>[]</index></name></decl></param>
)</parameter_list><block>{
  <function_decl><type><name>void</name></type> <name>jt_unregister</name><parameter_list>(<param><decl><type><name>void</name></type></decl></param>)</parameter_list>;</function_decl>

  <if>if<condition>( <expr><name>objc</name>!=1</expr> )</condition><then><block>{
    <expr_stmt><expr><call><name>Tcl_WrongNumArgs</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>1</expr></argument>, <argument><expr><name>objv</name></expr></argument>, <argument><expr>""</expr></argument>)</argument_list></call></expr>;</expr_stmt>
    <return>return <expr><name>TCL_ERROR</name></expr>;</return>
  }</block></then></if>

  <expr_stmt><expr><call><name>jt_unregister</name><argument_list>()</argument_list></call></expr>;</expr_stmt>
  <return>return <expr><name>TCL_OK</name></expr>;</return>
}</block></function>

<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif> <comment type="block">/* SQLITE_OMIT_DISKIO */</comment>

<comment type="block">/*
** This procedure registers the TCL procedures defined in this file.
*/</comment>
<function><type><name>int</name></type> <name>Sqlitetest6_Init</name><parameter_list>(<param><decl><type><name>Tcl_Interp</name> *</type><name>interp</name></decl></param>)</parameter_list><block>{
<cpp:ifndef>#<cpp:directive>ifndef</cpp:directive> <name>SQLITE_OMIT_DISKIO</name></cpp:ifndef>
  <expr_stmt><expr><call><name>Tcl_CreateObjCommand</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"sqlite3_crash_enable"</expr></argument>, <argument><expr><name>crashEnableCmd</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><call><name>Tcl_CreateObjCommand</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"sqlite3_crashparams"</expr></argument>, <argument><expr><name>crashParamsObjCmd</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><call><name>Tcl_CreateObjCommand</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"sqlite3_simulate_device"</expr></argument>, <argument><expr><name>devSymObjCmd</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><call><name>Tcl_CreateObjCommand</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"register_jt_vfs"</expr></argument>, <argument><expr><name>jtObjCmd</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
  <expr_stmt><expr><call><name>Tcl_CreateObjCommand</name><argument_list>(<argument><expr><name>interp</name></expr></argument>, <argument><expr>"unregister_jt_vfs"</expr></argument>, <argument><expr><name>jtUnregisterObjCmd</name></expr></argument>, <argument><expr>0</expr></argument>, <argument><expr>0</expr></argument>)</argument_list></call></expr>;</expr_stmt>
<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif>
  <return>return <expr><name>TCL_OK</name></expr>;</return>
}</block></function>

<cpp:endif>#<cpp:directive>endif</cpp:directive></cpp:endif> <comment type="block">/* SQLITE_TEST */</comment>
</unit>
